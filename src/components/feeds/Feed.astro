---
import Stack from "@components/feeds/Stack.astro";
import Card from "@components/cards/Post.astro";
import {
  db,
  alias,
  and,
  eq,
  isNull,
  desc,
  Post,
  User,
  Forum,
  Vote,
  countDistinct,
} from "astro:db";

interface Props {
  forum?: number;
  user?: number;
}
const { forum, user } = Astro.props;

const filters = [isNull(Post.parentId)];
if (forum !== undefined) filters.push(eq(Post.forumId, forum));
if (user !== undefined) filters.push(eq(Post.userId, user));

const Upvote = alias(Vote, "upvote");
const Downvote = alias(Vote, "downvote");
const Voted = alias(Vote, "Voted");
const Comment = alias(Post, "comment");

const posts = await db
  .select({
    postTitle: Post.title,
    postDescription: Post.description,
    postId: Post.id,
    userName: User.name,
    userId: User.id,
    forumName: Forum.name,
    forumId: Forum.id,
    upvotes: countDistinct(Upvote.userId),
    downvotes: countDistinct(Downvote.userId),
    votedScore: Voted.score,
    comments: countDistinct(Comment.id),
  })
  .from(Post)
  .where(and(...filters))
  .orderBy(desc(Post.createdAt))
  .innerJoin(User, eq(Post.userId, User.id))
  .innerJoin(Forum, eq(Post.forumId, Forum.id))
  .leftJoin(Upvote, and(eq(Upvote.postId, Post.id), eq(Upvote.score, 1)))
  .leftJoin(Downvote, and(eq(Downvote.postId, Post.id), eq(Downvote.score, -1)))
  .leftJoin(Voted, and(eq(Voted.postId, Post.id), eq(Voted.userId, Astro.locals.user?.id ?? -1)))
  .leftJoin(Comment, eq(Comment.parentId, Post.id))
  .groupBy(Post.id);
---

<Stack>
  {posts.map((post) => [<Card {...post} />, <hr />])}
</Stack>

<style lang="scss">
  hr {
    width: 100%;
    color: var(--accent);
  }
</style>

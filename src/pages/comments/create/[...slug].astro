---
import Layout from "@layouts/Layout.astro";
import Card from "@components/cards/Post.astro";
import Separator from "@components/feeds/Separator.astro";
import Send from "@components/actions/Send.astro";
import { eq, Post } from "astro:db";
import { selectPosts } from "@lib/db";

const { user } = Astro.locals;
if (!user) return Astro.redirect("/account/login");

const [postIdString, parentIdString, ...rest] = Astro.params.slug!.split("/");
if (rest.length) return new Response(null, { status: 404 });
const postId = parseInt(postIdString);
const parentId = parentIdString && parseInt(parentIdString);

const [post] = await selectPosts({ userId: Astro.locals.user?.id }).where(
  eq(Post.id, postId),
);
---

<Layout title={post.title ?? "Post"}>
  <Card {...post} />
  <Separator />
  <form method="post" action="/api/comment/create">
    <input name="postId" type="hidden" value={postId} />
    <input name="parentId" type="hidden" value={parentId} />
    <textarea
      autofocus={true}
      rows={5}
      name="description"
      required="true"
      placeholder="Schreibe einen Kommentar"></textarea>
    <Send />
  </form>
</Layout>

<style lang="scss">
  form {
    display: flex;
    flex-direction: column;
    gap: 0.5em;
  }
</style>
